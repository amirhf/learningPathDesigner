# Google Cloud Build Configuration with Deployment
# Builds images AND deploys to Cloud Run

steps:
  # Build all images first
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/rag-service:latest', './services/rag']
    id: 'build-rag'
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/planner-service:latest', './services/planner']
    id: 'build-planner'
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/quiz-service:latest', './services/quiz']
    id: 'build-quiz'
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/gateway:latest', './gateway']
    id: 'build-gateway'
  
  # Push all images to GCR (must complete before deployment)
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/rag-service:latest']
    id: 'push-rag'
    waitFor: ['build-rag']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/planner-service:latest']
    id: 'push-planner'
    waitFor: ['build-planner']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/quiz-service:latest']
    id: 'push-quiz'
    waitFor: ['build-quiz']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/gateway:latest']
    id: 'push-gateway'
    waitFor: ['build-gateway']
  
  # Deploy RAG Service
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    args:
      - 'gcloud'
      - 'run'
      - 'deploy'
      - 'rag-service'
      - '--image=gcr.io/$PROJECT_ID/rag-service:latest'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--memory=2Gi'
      - '--cpu=2'
      - '--timeout=300'
      - '--concurrency=10'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--cpu-boost'
      - '--set-secrets=DATABASE_URL=database-url:latest,QDRANT_URL=qdrant-url:latest,QDRANT_API_KEY=qdrant-api-key:latest'
      - '--set-env-vars=QDRANT_COLLECTION=resources,E5_MODEL_NAME=intfloat/e5-base-v2,RERANKER_MODEL_NAME=BAAI/bge-reranker-base,USE_QUANTIZATION=true,QUANTIZATION_CONFIG=int8,LOG_LEVEL=info'
    id: 'deploy-rag'
    waitFor: ['push-rag']
  
  # Deploy Planner Service
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        RAG_URL=$$(gcloud run services describe rag-service --region=${_REGION} --format="value(status.url)")
        gcloud run deploy planner-service \
          --image=gcr.io/$PROJECT_ID/planner-service:latest \
          --region=${_REGION} \
          --platform=managed \
          --allow-unauthenticated \
          --memory=1Gi \
          --cpu=1 \
          --timeout=300 \
          --concurrency=20 \
          --min-instances=0 \
          --max-instances=10 \
          --set-secrets=DATABASE_URL=database-url:latest,OPENROUTER_API_KEY=openrouter-api-key:latest \
          --set-env-vars=RAG_SERVICE_URL=$$RAG_URL,LLM_MODEL=anthropic/claude-3.5-sonnet,LOG_LEVEL=info
    id: 'deploy-planner'
    waitFor: ['push-planner', 'deploy-rag']
  
  # Deploy Quiz Service
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    args:
      - 'gcloud'
      - 'run'
      - 'deploy'
      - 'quiz-service'
      - '--image=gcr.io/$PROJECT_ID/quiz-service:latest'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--memory=1Gi'
      - '--cpu=1'
      - '--timeout=300'
      - '--concurrency=20'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--cpu-boost'
      - '--set-secrets=DATABASE_URL=database-url:latest,OPENROUTER_API_KEY=openrouter-api-key:latest,SUPABASE_URL=supabase-url:latest,SUPABASE_SERVICE_KEY=supabase-service-key:latest'
      - '--set-env-vars=STORAGE_BUCKET=learnpath-snippets,LLM_MODEL=anthropic/claude-3.5-sonnet,LOG_LEVEL=info'
    id: 'deploy-quiz'
    waitFor: ['push-quiz']
  
  # Deploy Gateway
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        RAG_URL=$$(gcloud run services describe rag-service --region=${_REGION} --format="value(status.url)")
        PLANNER_URL=$$(gcloud run services describe planner-service --region=${_REGION} --format="value(status.url)")
        QUIZ_URL=$$(gcloud run services describe quiz-service --region=${_REGION} --format="value(status.url)")
        gcloud run deploy gateway \
          --image=gcr.io/$PROJECT_ID/gateway:latest \
          --region=${_REGION} \
          --platform=managed \
          --allow-unauthenticated \
          --memory=512Mi \
          --cpu=1 \
          --timeout=60 \
          --concurrency=80 \
          --min-instances=0 \
          --max-instances=20 \
          --set-secrets=SUPABASE_URL=supabase-url:latest \
          --set-env-vars=RAG_SERVICE_URL=$$RAG_URL,PLANNER_SERVICE_URL=$$PLANNER_URL,QUIZ_SERVICE_URL=$$QUIZ_URL,JWT_PUBLIC_KEY_URL=https://hywmzhvyhiynewfsmqln.supabase.co/auth/v1/jwks,ALLOWED_ORIGINS=${_ALLOWED_ORIGINS},RATE_LIMIT_REQUESTS=100,RATE_LIMIT_WINDOW=60,LOG_LEVEL=info
    id: 'deploy-gateway'
    waitFor: ['push-gateway', 'deploy-rag', 'deploy-planner', 'deploy-quiz']

# Images are pushed explicitly in the steps above
# No need to list them here again

substitutions:
  _REGION: 'europe-west1'
  _ALLOWED_ORIGINS: 'https://your-app.vercel.app'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '2400s'  # 40 minutes
